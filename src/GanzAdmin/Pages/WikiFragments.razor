@page "/wikifrags"
@page "/wikifrags/{PopupDisplay}"

@inherits DataHandlingController<ContentFragment>

<aside class='@(this.ItemList == null ? "loading" : "")'>
    @if (this.ItemList != null)
    {
        @*<TreeLevel Items="@(this.ItemList.ToEntities<Part>())" 
                   Root="@null" 
                   Filter="@((e, r) => (e as Part).Category == null && r == null || (e as Part).Category?.Id == r?.Id)" />*@
    }
    <AuthorizedView NeededRolesOR="@Permissions.EditFrags">
        <NavLink class="addlink" href="@($"/{this.BaseLink}/add")">Új @this.DataName</NavLink>
    </AuthorizedView>
</aside>

<main class='@(this.ItemList == null ? "loading" : "")'>
    @if (this.ItemList != null)
    {
        <div id='table-wrapper'>
            <table id='data' class="display nowrap">
                <thead>
                    <tr>
                        <DataGridHeader IsPinnable IsSortable>Név</DataGridHeader>
                        <DataGridHeader IsCollapsible>Állapot</DataGridHeader>
                    </tr>
                </thead>

                <tbody>
                    @foreach (ContentFragment item in this.ItemList)
                    {
                        <tr>
                            <td>
                                <NavLink href="@($"/{this.BaseLink}/{item.Id}")">@item.Name</NavLink>
                            </td>
                            <td>
                                --- @*TODO*@
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</main>

@if (this.SelectedItem != null)
{
    <section class='popup' id='content'>
        <div class='shadow'></div>
        <div class='body'>
            <div class='header'>
                <h2>@this.PopupTitle</h2>
                <a class='button' href="@($"/{this.BaseLink}")"></a>
            </div>

            <EditForm method="post" EditContext="new EditContext(true)" OnSubmit="OnDefaultAddEditSubmit">
                <div class='dynamic'>
                    <SimpleTextField AuthOR="@Permissions.EditFrags"
                                     Type="text"
                                     Display="Név"
                                     Name="@nameof(Part.Name)"
                                     @bind-Value="this.SelectedItem.Temporal.Name" />
                    <SimpleCheckField AuthOR="@Permissions.EditCourse"
                                        Type="switch"
                                        Display="Interaktív?"
                                        Name="@nameof(WikiPage.IsCoded)"
                                        PreventRenderOnChange="false"
                                        @bind-Value="this.SelectedItem.Temporal.IsCoded" />
                    @if (this.SelectedItem.Temporal.IsCoded)
                    {
                        string[] frags = this.SelectedItem.Temporal.Content?.Split(ContentFragment.CODE_SEPARATOR);
                        string html = frags?.Length > 0 ? frags[0] : null;
                        string css = frags?.Length > 1 ? frags[1] : null;
                        string js = frags?.Length > 2 ? frags[2] : null;

                        <div class="triple-editor">
                            <section>
                                <h2>HTML</h2>
                                <CodeEditor @ref="this.htmlEditor" Language="htmlmixed" Value="@html"></CodeEditor>
                            </section>
                            <section>
                                <h2>CSS</h2>
                                <CodeEditor @ref="this.cssEditor" Language="css" Value="@css"></CodeEditor>
                            </section>
                            <section>
                                <h2>JS</h2>
                                <CodeEditor @ref="this.jsEditor" Language="javascript" Value="@js"></CodeEditor>
                            </section>
                        </div>
                    }
                    else
                    {
                        <WysiwygEditor @bind-Value="@this.SelectedItem.Temporal.Content"></WysiwygEditor>
                    }

                    <AuthorizedView NeededRolesOR="@($"{Permissions.EditFrags}")">
                        <button type='submit'>Küldés</button>
                    </AuthorizedView>
                    @if (this.PopupDisplay != "add")
                    {
                        <AuthorizedView NeededRolesOR="@Permissions.DeleteFrags">
                            <input type='button' class="delete" value="Törlés" @onclick="OnDefaultDeleteSubmit" />
                        </AuthorizedView>
                    }
                </div>
            </EditForm>
        </div>
        @if (this.DialogLoading)
        {
            <div class='loading'> </div>
        }
    </section>
}


@code
{
    protected override string BaseLink { get; set; } = "wikifrags";
    protected override string DataName { get; set; } = "morzsa";

    private CodeEditor htmlEditor;
    private CodeEditor jsEditor;
    private CodeEditor cssEditor;

    protected string GetCodeValue()
    {
        return this.htmlEditor.Value + ContentFragment.CODE_SEPARATOR + this.cssEditor.Value + ContentFragment.CODE_SEPARATOR + this.jsEditor.Value;
    }

    private void OnItemEdit()
    {
        if (this.SelectedItem.Temporal.IsCoded)
        {
            this.SelectedItem.Temporal.Content = this.GetCodeValue();
        }
        this.SelectedItem.Temporal.LastModified = DateTime.Now;
    }

    protected override bool BeforeEdit()
    {
        this.OnItemEdit();
        return true;
    }

    protected bool BeforeCancel()
    {
        this.OnItemEdit();
        return true;
    }
}
